<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–ü–æ—à–∞–≥–æ–≤—ã–π –∞–≤—Ç–æ–±–∞—Ç—Ç–ª–µ—Ä</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    color-scheme: light dark;
    --bg: radial-gradient(1200px 600px at 10% -10%, #cce4ff40, transparent),
          radial-gradient(1000px 500px at 110% 30%, #ffd1dc40, transparent),
          linear-gradient(180deg, #0f172a, #0b1024);
    --card-bg: #ffffff18;
    --card-brd: #ffffff2a;
    --text: #e6eaf5;
    --muted: #a3acc2;
    --accent: #7dd3fc;
    --accent-2: #c084fc;
    --ok: #22c55e;
    --warn: #f59e0b;
    --err: #ef4444;
    --chip-bg: #ffffff22;
    --shadow: 0 10px 30px #00000040;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg: linear-gradient(180deg, #eef2ff, #ffffff);
      --card-bg: #ffffffcc;
      --card-brd: #e6e9f5;
      --text: #0b1220;
      --muted: #5b667d;
      --accent: #2563eb;
      --accent-2: #7c3aed;
      --chip-bg: #f3f4f6;
      --shadow: 0 10px 24px #0b122015;
    }
  }
  html,body{height:100%}
  body{
    margin:0; font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
  }
  .container{max-width: 1100px; margin: 24px auto; padding: 0 16px;}
  .topbar{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    background: var(--card-bg); border: 1px solid var(--card-brd); border-radius:16px; padding:14px 16px; box-shadow: var(--shadow);
    backdrop-filter: blur(8px);
  }
  .brand{display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.2px;}
  .brand .logo{font-size:22px}
  .streak{display:inline-flex; align-items:center; gap:8px; background: linear-gradient(90deg, var(--accent), var(--accent-2));
    color:#fff; padding:6px 10px; border-radius:999px; font-weight:600; box-shadow: var(--shadow);}
  .controls{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
  .btn{
    padding:8px 12px; border-radius:10px; border:1px solid var(--card-brd);
    background: var(--chip-bg); color: var(--text); cursor:pointer; transition: .2s transform, .2s background;
  }
  .btn:hover{transform: translateY(-1px); background: #ffffff33}
  .btn.primary{background: linear-gradient(90deg, var(--accent), var(--accent-2)); color:white; border:0}
  .slider-wrap{display:flex; align-items:center; gap:8px; color: var(--muted); font-size:14px}
  input[type=range]{accent-color: var(--accent); width:160px}

  .grid{display:grid; gap:16px}
  .cols-2{grid-template-columns: repeat(2, minmax(0,1fr))}
  .cols-3{grid-template-columns: repeat(3, minmax(0,1fr))}
  @media(max-width:900px){ .cols-2, .cols-3{grid-template-columns: 1fr} }

  .card{
    background: var(--card-bg); border:1px solid var(--card-brd); border-radius:16px; padding:16px; box-shadow: var(--shadow);
    backdrop-filter: blur(8px);
  }
  h1{margin:0; font-size:20px}
  h2{margin:0 0 10px; font-size:18px}

  .stat{display:flex; align-items:center; gap:8px; color: var(--muted)}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background: var(--chip-bg); font-weight:600}

  .hpbar{position:relative; height:22px; border-radius:999px; background:#ffffff1a; overflow:hidden; border:1px solid var(--card-brd)}
  .hpfill{position:absolute; left:0; top:0; bottom:0; width:0%; background:#22c55e; transition: width .45s ease, background .3s ease}
  .hptext{position:relative; z-index:2; text-align:center; font-weight:700; font-size:13px; color:#fff; text-shadow:0 1px 2px #0006}
  .hpbar.hit .hpfill{animation: hitflash .45s}
  @keyframes hitflash{
    0%{filter:brightness(1.6)}
    100%{filter:brightness(1)}
  }

  .row{display:flex; gap:10px; flex-wrap:wrap}

  .log{background:#0a0f1d; color:#c7f9cc; border-radius:12px; padding:12px; height:330px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px; border:1px solid #0d1328}
  .muted{color: var(--muted)}

  .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-weight:700; font-size:12px; border:1px solid var(--card-brd); background: var(--chip-bg)}
  .chip.red{background:#ef44441a; color:#fecaca; border-color:#ef44444a}
  .chip.blue{background:#3b82f61a; color:#bfdbfe; border-color:#3b82f64a}
  .chip.brown{background:#92400e1a; color:#fed7aa; border-color:#b453094a}
  .effects{display:flex; gap:6px; flex-wrap:wrap}

  .entity{display:grid; gap:10px}
  .entity .hdr{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .title{display:flex; align-items:center; gap:10px; font-size:18px; font-weight:800}
  .title .emoji{font-size:22px}

  .weapon{display:flex; align-items:center; gap:8px}
  .badge{display:inline-flex; align-items:center; gap:6px; background: var(--chip-bg); padding:4px 8px; border-radius:8px; border:1px solid var(--card-brd)}
  .sep{height:1px; background: var(--card-brd); margin:10px 0}

  .center{display:flex; align-items:center; justify-content:center}
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">
      <div class="logo">‚öîÔ∏è</div>
      <div>
        <div style="font-size:16px; font-weight:800;">–ü–æ—à–∞–≥–æ–≤—ã–π –∞–≤—Ç–æ–±–∞—Ç—Ç–ª–µ—Ä</div>
        <div class="stat"><span class="pill">–°–µ—Ä–∏—è –ø–æ–±–µ–¥: <span id="wins">0</span></span></div>
      </div>
    </div>
    <div class="controls">
      <div class="slider-wrap">
        ‚è± –°–∫–æ—Ä–æ—Å—Ç—å
        <input id="speed" type="range" min="200" max="1200" step="50" value="600">
        <span id="speedval" class="muted">600 –º—Å</span>
      </div>
      <button class="btn" id="btn-pause">‚è∏ –ü–∞—É–∑–∞</button>
      <button class="btn" id="btn-step" title="–°–¥–µ–ª–∞—Ç—å —Ö–æ–¥ (–≤ –ø–∞—É–∑–µ)">üëâ –•–æ–¥</button>
      <button class="btn primary" id="btn-restart-top">üîÑ –°–±—Ä–æ—Å</button>
    </div>
  </div>

  <div class="grid cols-2" style="margin-top:16px;">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="grid" style="gap:16px;">
      <div class="card" id="choose" style="display:none;">
        <h2>–í—ã–±–æ—Ä –∫–ª–∞—Å—Å–∞</h2>
        <div class="row" style="margin-top:8px;">
          <button class="btn" data-action="choose" data-cls="–†–∞–∑–±–æ–π–Ω–∏–∫">üó°Ô∏è –†–∞–∑–±–æ–π–Ω–∏–∫</button>
          <button class="btn" data-action="choose" data-cls="–í–æ–∏–Ω">‚öîÔ∏è –í–æ–∏–Ω</button>
          <button class="btn" data-action="choose" data-cls="–í–∞—Ä–≤–∞—Ä">ü™ì –í–∞—Ä–≤–∞—Ä</button>
        </div>
        <div class="sep"></div>
        <div class="stat">–°—Ç–∞—Ä—Ç–æ–≤—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã: –°–∏–ª–∞ <b id="bstr">-</b>, –õ–æ–≤–∫ <b id="bagi">-</b>, –í—ã–Ω–æ—Å <b id="bend">-</b></div>
      </div>

      <div class="card" id="player-card">
        <div class="entity">
          <div class="hdr">
            <div class="title"><span class="emoji">üßô‚Äç‚ôÇÔ∏è</span> –ò–≥—Ä–æ–∫</div>
            <div class="badge">–£—Ä–æ–≤–Ω–∏: –†–∞–∑–± <b id="lv-rogue">0</b>, –í–æ–∏–Ω <b id="lv-warrior">0</b>, –í–∞—Ä–≤ <b id="lv-barbarian">0</b></div>
          </div>
          <div class="hpbar" id="pbar"><div class="hpfill" id="pbar-fill"></div><div class="hptext" id="pbar-text">-/-</div></div>
          <div class="row">
            <div class="badge">–°–∏–ª–∞: <b id="pstr">-</b></div>
            <div class="badge">–õ–æ–≤–∫: <b id="pagi">-</b></div>
            <div class="badge">–í—ã–Ω–æ—Å: <b id="pend">-</b></div>
          </div>
          <div class="weapon">
            <div class="badge">–û—Ä—É–∂–∏–µ: <span id="wicon">‚öîÔ∏è</span> <b id="wname">-</b> (<span id="wdmg">-</span>)</div>
            <div class="chip" id="wdtype-chip">–¢–∏–ø: <span id="wdtype">-</span></div>
          </div>
        </div>
      </div>

      <div class="card" id="loot" style="display:none;">
        <h2>–î–æ–±—ã—á–∞</h2>
        <div class="row">
          <div class="badge">–í—ã–ø–∞–ª–æ: <span id="loot-emoji">‚ùì</span> <b id="loot-name">-</b> (<span id="loot-dmg">-</span>)</div>
          <div class="chip" id="loot-type-chip">–¢–∏–ø: <span id="loot-type">-</span></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="badge">–¢–µ–∫—É—â–µ–µ: <span id="curw-emoji">‚ùì</span> <b id="curw-name">-</b> (<span id="curw-dmg">-</span>)</div>
          <div class="chip" id="curw-type-chip">–¢–∏–ø: <span id="curw-type">-</span></div>
        </div>
        <div class="row" style="margin-top:12px;">
          <button class="btn primary" data-action="loot" data-take="yes">–í–∑—è—Ç—å</button>
          <button class="btn" data-action="loot" data-take="no">–û—Å—Ç–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <div class="card" id="levelup" style="display:none;">
        <h2>–ü–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è</h2>
        <div class="muted">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å—É–º–º–∞—Ä–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å ‚Äî 3. –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å:</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" data-action="level" data-cls="–†–∞–∑–±–æ–π–Ω–∏–∫">üó°Ô∏è –†–∞–∑–±–æ–π–Ω–∏–∫</button>
          <button class="btn" data-action="level" data-cls="–í–æ–∏–Ω">‚öîÔ∏è –í–æ–∏–Ω</button>
          <button class="btn" data-action="level" data-cls="–í–∞—Ä–≤–∞—Ä">ü™ì –í–∞—Ä–≤–∞—Ä</button>
        </div>
      </div>

      <div class="card">
        <h2>–ñ—É—Ä–Ω–∞–ª</h2>
        <div id="log" class="log"></div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="grid" style="gap:16px;">
      <div class="card" id="fight" style="display:none;">
        <div class="entity">
          <div class="hdr">
            <div class="title"><span class="emoji" id="memoji">üëπ</span> <span id="mname">-</span></div>
            <div class="weapon">
              <div class="badge">–û—Ä—É–∂–∏–µ: <span id="mwicon">‚öîÔ∏è</span> <b id="mwname">-</b> (<span id="mwdmg">-</span>)</div>
              <div class="chip" id="mwdtype-chip">–¢–∏–ø: <span id="mwdtype">-</span></div>
            </div>
          </div>
          <div class="hpbar" id="mbar"><div class="hpfill" id="mbar-fill"></div><div class="hptext" id="mbar-text">-/-</div></div>
          <div class="row">
            <div class="badge">–°–∏–ª–∞: <b id="mstr">-</b></div>
            <div class="badge">–õ–æ–≤–∫: <b id="magi">-</b></div>
            <div class="badge">–í—ã–Ω–æ—Å: <b id="mend">-</b></div>
          </div>
          <div class="sep"></div>
          <div class="effects" id="last-effects"></div>
          <div class="muted" id="auto-status">–û–∂–∏–¥–∞–Ω–∏–µ‚Ä¶</div>
        </div>
      </div>

      <div class="card center" id="victory" style="display:none;">
        <div>
          <h2>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h2>
          <div>–í—ã –ø–æ–±–µ–¥–∏–ª–∏ 5 –º–æ–Ω—Å—Ç—Ä–æ–≤ –ø–æ–¥—Ä—è–¥. –ò–≥—Ä–∞ –ø—Ä–æ–π–¥–µ–Ω–∞!</div>
          <div class="row" style="margin-top:10px;">
            <button class="btn primary" id="btn-restart-1">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
          </div>
        </div>
      </div>

      <div class="card center" id="defeat" style="display:none;">
        <div>
          <h2>üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ</h2>
          <div>–í—ã –ø–∞–ª–∏ –≤ –±–æ—é. –°–µ—Ä–∏—è –ø–æ–±–µ–¥ —Å–±—Ä–æ—à–µ–Ω–∞.</div>
          <div class="row" style="margin-top:10px;">
            <button class="btn primary" id="btn-restart-2">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // -------------------- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã --------------------
  const DAMAGE_SLASH = "–†—É–±—è—â–∏–π";
  const DAMAGE_BLUNT = "–î—Ä–æ–±—è—â–∏–π";
  const DAMAGE_PIERCE = "–ö–æ–ª—é—â–∏–π";

  // -------------------- –û—Ä—É–∂–∏–µ -----------------------
  class Weapon {
    constructor(name, damage, dmg_type) {
      this.name = name;
      this.damage = damage;
      this.dmg_type = dmg_type;
    }
  }

  const WEAPONS = {
    "–ú–µ—á": new Weapon("–ú–µ—á", 3, DAMAGE_SLASH),
    "–î—É–±–∏–Ω–∞": new Weapon("–î—É–±–∏–Ω–∞", 3, DAMAGE_BLUNT),
    "–ö–∏–Ω–∂–∞–ª": new Weapon("–ö–∏–Ω–∂–∞–ª", 2, DAMAGE_PIERCE),
    "–¢–æ–ø–æ—Ä": new Weapon("–¢–æ–ø–æ—Ä", 4, DAMAGE_SLASH),
    "–ö–æ–ø—å–µ": new Weapon("–ö–æ–ø—å–µ", 3, DAMAGE_PIERCE),
    "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –ú–µ—á": new Weapon("–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –ú–µ—á", 10, DAMAGE_SLASH),
  };

  const weaponIcon = (name) => ({
    "–ú–µ—á":"‚öîÔ∏è","–î—É–±–∏–Ω–∞":"üî®","–ö–∏–Ω–∂–∞–ª":"üó°Ô∏è","–¢–æ–ø–æ—Ä":"ü™ì","–ö–æ–ø—å–µ":"üó°Ô∏è","–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –ú–µ—á":"üó°Ô∏è‚ú®"
  }[name] || "‚öîÔ∏è");

  const monsterIcon = (name) => ({
    "–ì–æ–±–ª–∏–Ω":"üë∫","–°–∫–µ–ª–µ—Ç":"‚ò†Ô∏è","–°–ª–∞–π–º":"üß™","–ü—Ä–∏–∑—Ä–∞–∫":"üëª","–ì–æ–ª–µ–º":"üóø","–î—Ä–∞–∫–æ–Ω":"üêâ"
  }[name] || "üëπ");

  const dmgChipClass = (t) => t===DAMAGE_SLASH ? "red" : t===DAMAGE_PIERCE ? "blue" : "brown";

  // -------------------- –ò–≥—Ä–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã --------------------
  const CLASS_ROGUE = "–†–∞–∑–±–æ–π–Ω–∏–∫";
  const CLASS_WARRIOR = "–í–æ–∏–Ω";
  const CLASS_BARBARIAN = "–í–∞—Ä–≤–∞—Ä";

  const CLASS_HP_PER_LEVEL = {
    [CLASS_ROGUE]: 4,
    [CLASS_WARRIOR]: 5,
    [CLASS_BARBARIAN]: 6,
  };

  const CLASS_START_WEAPON = {
    [CLASS_ROGUE]: WEAPONS["–ö–∏–Ω–∂–∞–ª"],
    [CLASS_WARRIOR]: WEAPONS["–ú–µ—á"],
    [CLASS_BARBARIAN]: WEAPONS["–î—É–±–∏–Ω–∞"],
  };

  // -------------------- –ú–æ–Ω—Å—Ç—Ä—ã --------------------
  class Monster {
    constructor(name, max_hp, weapon, strength, agility, endurance, drop_weapon, has_hidden_attack=false, has_stone_skin=false, is_skeleton=false, is_slime=false, is_dragon=false) {
      this.name = name;
      this.max_hp = max_hp;
      this.weapon = weapon;
      this.strength = strength;
      this.agility = agility;
      this.endurance = endurance;
      this.drop_weapon = drop_weapon;
      this.has_hidden_attack = has_hidden_attack;
      this.has_stone_skin = has_stone_skin;
      this.is_skeleton = is_skeleton;
      this.is_slime = is_slime;
      this.is_dragon = is_dragon;
      this.hp = 0;
      this.turns_done = 0;
    }
    reset_for_combat() {
      this.hp = this.max_hp;
      this.turns_done = 0;
    }
  }

  function randomChoice(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function randomMonster() {
    const pool = [
      new Monster("–ì–æ–±–ª–∏–Ω", 5, WEAPONS["–ö–∏–Ω–∂–∞–ª"], 1, 1, 1, WEAPONS["–ö–∏–Ω–∂–∞–ª"]),
      new Monster("–°–∫–µ–ª–µ—Ç", 10, WEAPONS["–î—É–±–∏–Ω–∞"], 2, 2, 1, WEAPONS["–î—É–±–∏–Ω–∞"], false, false, true),
      new Monster("–°–ª–∞–π–º", 8, WEAPONS["–ö–æ–ø—å–µ"], 3, 1, 2, WEAPONS["–ö–æ–ø—å–µ"], false, false, false, true),
      new Monster("–ü—Ä–∏–∑—Ä–∞–∫", 6, WEAPONS["–ú–µ—á"], 1, 3, 1, WEAPONS["–ú–µ—á"], true),
      new Monster("–ì–æ–ª–µ–º", 10, WEAPONS["–¢–æ–ø–æ—Ä"], 3, 1, 3, WEAPONS["–¢–æ–ø–æ—Ä"], false, true),
      new Monster("–î—Ä–∞–∫–æ–Ω", 20, WEAPONS["–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –ú–µ—á"], 4, 3, 3, WEAPONS["–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –ú–µ—á"], false, false, false, false, true),
    ];
    const m = randomChoice(pool);
    const c = new Monster(m.name, m.max_hp, m.weapon, m.strength, m.agility, m.endurance, m.drop_weapon, m.has_hidden_attack, m.has_stone_skin, m.is_skeleton, m.is_slime, m.is_dragon);
    c.reset_for_combat();
    return c;
  }

  // -------------------- –ü–µ—Ä—Å–æ–Ω–∞–∂ --------------------
  class Character {
    constructor(base_str, base_agi, base_end, first_class) {
      this.strength = base_str;
      this.agility = base_agi;
      this.endurance = base_end;
      this.levels = { [CLASS_ROGUE]: 0, [CLASS_WARRIOR]: 0, [CLASS_BARBARIAN]: 0 };
      this.total_level = 0;
      this.weapon = CLASS_START_WEAPON[first_class];
      this.max_hp = 0;
      this.hp = 0;
      this.turns_done = 0;
      this.gain_level(first_class, true);
      this.hp = this.max_hp;
    }
    reset_for_combat() {
      this.turns_done = 0;
      this.hp = this.max_hp;
    }
    can_level_up() { return this.total_level < 3; }
    class_level(cls) { return this.levels[cls] || 0; }
    apply_class_level_bonuses_if_any(cls, new_level_in_class) {
      if (cls === CLASS_ROGUE) {
        if (new_level_in_class === 2) this.agility += 1;
      } else if (cls === CLASS_WARRIOR) {
        if (new_level_in_class === 3) this.strength += 1;
      } else if (cls === CLASS_BARBARIAN) {
        if (new_level_in_class === 3) this.endurance += 1;
      }
    }
    gain_level(cls, silent=false) {
      if (!this.can_level_up()) return;
      this.levels[cls] = (this.levels[cls] || 0) + 1;
      this.total_level += 1;
      this.apply_class_level_bonuses_if_any(cls, this.levels[cls]);
      const gained_hp = CLASS_HP_PER_LEVEL[cls] + this.endurance;
      this.max_hp += gained_hp;
      this.hp = this.max_hp;
    }
    has_rogue_hidden_attack() { return this.class_level(CLASS_ROGUE) >= 1; }
    has_rogue_poison() { return this.class_level(CLASS_ROGUE) >= 3; }
    has_warrior_poryv() { return this.class_level(CLASS_WARRIOR) >= 1; }
    has_warrior_shield() { return this.class_level(CLASS_WARRIOR) >= 2; }
    has_barbarian_rage() { return this.class_level(CLASS_BARBARIAN) >= 1; }
    has_barbarian_stone_skin() { return this.class_level(CLASS_BARBARIAN) >= 2; }
  }

  // -------------------- –ë–æ–π --------------------
  function roll_hit(attacker_agility, defender_agility) {
    const total = attacker_agility + defender_agility;
    if (total <= 0) return true;
    const r = 1 + Math.floor(Math.random() * total);
    return !(r <= defender_agility);
  }

  function compute_attack_damage({
    attacker_is_player,
    attacker_weapon,
    attacker_strength,
    attacker_agility,
    attacker_turns_done,
    defender_is_player,
    defender_strength,
    defender_agility,
    defender_endurance,
    defender_traits,
    player_effects
  }) {
    let weapon_component = attacker_weapon.damage;
    if (defender_traits.is_slime && attacker_weapon.dmg_type === DAMAGE_SLASH) {
      weapon_component = 0;
    }

    let flat_bonus = 0;
    const notes = {};

    // –°–∫—Ä—ã—Ç–∞—è –∞—Ç–∞–∫–∞
    let has_hidden = false;
    if (attacker_is_player && player_effects.rogue_hidden) has_hidden = true;
    if (defender_traits.attacker_is_ghost) has_hidden = true;
    if (has_hidden && attacker_agility > defender_agility) {
      flat_bonus += 1; notes.hidden = 1;
    }

    // –ü–æ—Ä—ã–≤ (–ø–µ—Ä–≤—ã–π —Ö–æ–¥)
    if (attacker_is_player && player_effects.warrior_poryv && attacker_turns_done === 0) {
      const poryv_extra = attacker_weapon.damage;
      if (defender_traits.is_slime && attacker_weapon.dmg_type === DAMAGE_SLASH) {
        flat_bonus += poryv_extra;
      } else {
        weapon_component += poryv_extra;
      }
      notes.poryv = poryv_extra;
    }

    // –Ø—Ä–æ—Å—Ç—å –≤–∞—Ä–≤–∞—Ä–∞
    if (attacker_is_player && player_effects.barbarian_rage) {
      if (attacker_turns_done < 3) { flat_bonus += 2; notes.rage = 2; }
      else { flat_bonus -= 1; notes.rage = -1; }
    }

    // –Ø–¥ —Ä–∞–∑–±–æ–π–Ω–∏–∫–∞
    if (attacker_is_player && player_effects.rogue_poison && attacker_turns_done >= 1) {
      const poison = attacker_turns_done;
      flat_bonus += poison; notes.poison = poison;
    }

    // –î—ã—Ö–∞–Ω–∏–µ –¥—Ä–∞–∫–æ–Ω–∞ (—É –∞—Ç–∞–∫—É—é—â–µ–≥–æ)
    if (defender_traits.attacker_is_dragon && ((attacker_turns_done + 1) % 3 === 0)) {
      flat_bonus += 3; notes.dragon_breath = 3;
    }

    let damage = weapon_component + attacker_strength + flat_bonus;

    // –ó–∞—â–∏—Ç–∞ —Ü–µ–ª–∏
    if (defender_is_player && player_effects.warrior_shield_on_def && defender_strength > attacker_strength) {
      damage -= 3; notes.shield = -3;
    }
    if (defender_is_player && player_effects.barbarian_skin_on_def && defender_endurance > 0) {
      damage -= defender_endurance; notes.stone_skin = -defender_endurance;
    }
    if (defender_traits.is_golem && defender_endurance > 0) {
      damage -= defender_endurance; notes.golem_skin = -defender_endurance;
    }
    if (defender_traits.is_skeleton && attacker_weapon.dmg_type === DAMAGE_BLUNT) {
      damage *= 2; notes.skeleton_x2 = 2;
    }

    if (damage < 0) damage = 0;
    return { damage, notes };
  }

  // -------------------- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã --------------------
  const Phase = {
    Choose: 'choose_class',
    Fight: 'in_fight',
    Loot: 'loot',
    LevelUp: 'level_up',
    Victory: 'victory',
    Defeat: 'defeat',
  };

  function randAttr() { return 1 + Math.floor(Math.random() * 3); }

  function newGameState() {
    const base_str = randAttr(), base_agi = randAttr(), base_end = randAttr();
    return {
      base_str, base_agi, base_end,
      chosen_class: null,
      player: null,
      monster: null,
      wins_in_row: 0,
      phase: Phase.Choose,
      log: [
        "–°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞. –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å.",
        `–ê—Ç—Ä–∏–±—É—Ç—ã: –°–∏–ª–∞ ${base_str}, –õ–æ–≤–∫ ${base_agi}, –í—ã–Ω–æ—Å ${base_end}`
      ],
      player_turn: true,
      round_idx: 1,
      auto: true,
      speedMs: 600,
      lastNotes: [],
      prevPlayerHP: null,
      prevMonsterHP: null,
    };
  }

  const state = newGameState();

  function player_effects_for(player) {
    return {
      rogue_hidden: player.has_rogue_hidden_attack(),
      rogue_poison: player.has_rogue_poison(),
      warrior_poryv: player.has_warrior_poryv(),
      warrior_shield_on_def: player.has_warrior_shield(),
      barbarian_rage: player.has_barbarian_rage(),
      barbarian_skin_on_def: player.has_barbarian_stone_skin(),
    };
  }

  // -------------------- –ê–≤—Ç–æ-—Ö–æ–¥—ã --------------------
  let autoplayTimer = null;

  function stopAutoplay() {
    if (autoplayTimer !== null) {
      clearInterval(autoplayTimer);
      autoplayTimer = null;
    }
    setAutoStatus();
  }

  function startAutoplay() {
    stopAutoplay();
    if (!state.auto || state.phase !== Phase.Fight) return;
    autoplayTimer = setInterval(() => {
      if (state.phase !== Phase.Fight) { stopAutoplay(); return; }
      do_turn();
    }, state.speedMs);
    setAutoStatus();
  }

  function setAutoStatus() {
    const s = document.getElementById("auto-status");
    if (!s) return;
    s.textContent = state.phase === Phase.Fight
      ? (autoplayTimer ? "–•–æ–¥—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏‚Ä¶" : "–ü–∞—É–∑–∞")
      : "–û–∂–∏–¥–∞–Ω–∏–µ‚Ä¶";
  }

  // -------------------- –ë–æ–π --------------------
  function start_fight() {
    const p = state.player;
    const m = randomMonster();
    state.monster = m;
    p.reset_for_combat();
    m.reset_for_combat();

    // –ö—Ç–æ —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º
    let player_turn = !(m.agility > p.agility);
    state.player_turn = player_turn;
    state.round_idx = 1;
    state.phase = Phase.Fight;
    state.lastNotes = [];
    state.prevMonsterHP = m.hp;
    state.prevPlayerHP = p.hp;

    state.log.push("");
    state.log.push("====================================");
    state.log.push(`–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫: ${m.name}`);
    state.log.push(`HP: ${m.hp}/${m.max_hp}, –°–∏–ª–∞ ${m.strength}, –õ–æ–≤–∫ ${m.agility}, –í—ã–Ω–æ—Å ${m.endurance}`);
    state.log.push(`–û—Ä—É–∂–∏–µ: ${m.weapon.name} (${m.weapon.damage}, ${m.weapon.dmg_type})`);
    state.log.push("====================================");
    state.log.push(`-- –†–∞—É–Ω–¥ ${state.round_idx} --`);
    render();
    if (state.auto) startAutoplay();
  }

  function do_turn() {
    if (state.phase !== Phase.Fight || !state.player || !state.monster) return;
    const p = state.player, m = state.monster;
    const effects = player_effects_for(p);
    state.lastNotes = [];

    if (state.player_turn) {
      if (!roll_hit(p.agility, m.agility)) {
        state.log.push("–ò–≥—Ä–æ–∫ –ø—Ä–æ–º–∞—Ö–∏–≤–∞–µ—Ç—Å—è!");
      } else {
        const { damage, notes } = compute_attack_damage({
          attacker_is_player: true,
          attacker_weapon: p.weapon,
          attacker_strength: p.strength,
          attacker_agility: p.agility,
          attacker_turns_done: p.turns_done,
          defender_is_player: false,
          defender_strength: m.strength,
          defender_agility: m.agility,
          defender_endurance: m.endurance,
          defender_traits: {
            is_skeleton: m.is_skeleton,
            is_slime: m.is_slime,
            is_golem: m.has_stone_skin,
            attacker_is_ghost: false,
            attacker_is_dragon: false,
          },
          player_effects: effects
        });
        m.hp -= damage;
        state.log.push(`–ò–≥—Ä–æ–∫ –±—å—ë—Ç (${p.weapon.name}) –∏ –Ω–∞–Ω–æ—Å–∏—Ç ${damage} —É—Ä–æ–Ω–∞. [${m.name} HP ${Math.max(m.hp,0)}/${m.max_hp}]`);
        const noteKeys = Object.keys(notes);
        if (noteKeys.length) {
          state.lastNotes = noteKeys.map(k => `${k}:${notes[k]}`);
          state.log.push("–≠—Ñ—Ñ–µ–∫—Ç—ã: " + state.lastNotes.join(", "));
        }
        p.turns_done += 1;
        if (m.hp <= 0) {
          state.log.push(`${m.name} –ø–æ–≤–µ—Ä–∂–µ–Ω!`);
          state.wins_in_row += 1;
          state.log.push(`–ü–æ–±–µ–¥–∞! –°–µ—Ä–∏—è –ø–æ–±–µ–¥: ${state.wins_in_row}`);
          p.hp = p.max_hp; // –ª–µ—á–µ–Ω–∏–µ
          state.phase = Phase.Loot;
          render();
          stopAutoplay();
          return;
        }
      }
    } else {
      if (!roll_hit(m.agility, p.agility)) {
        state.log.push(`${m.name} –ø—Ä–æ–º–∞—Ö–∏–≤–∞–µ—Ç—Å—è!`);
      } else {
        const { damage, notes } = compute_attack_damage({
          attacker_is_player: false,
          attacker_weapon: m.weapon,
          attacker_strength: m.strength,
          attacker_agility: m.agility,
          attacker_turns_done: m.turns_done,
          defender_is_player: true,
          defender_strength: p.strength,
          defender_agility: p.agility,
          defender_endurance: p.endurance,
          defender_traits: {
            is_skeleton: false,
            is_slime: false,
            is_golem: false,
            attacker_is_ghost: m.has_hidden_attack,
            attacker_is_dragon: m.is_dragon,
          },
          player_effects: effects
        });
        p.hp -= damage;
        state.log.push(`${m.name} –∞—Ç–∞–∫—É–µ—Ç (${m.weapon.name}) –∏ –Ω–∞–Ω–æ—Å–∏—Ç ${damage} —É—Ä–æ–Ω–∞. [–ò–≥—Ä–æ–∫ HP ${Math.max(p.hp,0)}/${p.max_hp}]`);
        const noteKeys = Object.keys(notes);
        if (noteKeys.length) {
          state.lastNotes = noteKeys.map(k => `${k}:${notes[k]}`);
          state.log.push("–≠—Ñ—Ñ–µ–∫—Ç—ã: " + state.lastNotes.join(", "));
        }
        m.turns_done += 1;
        if (p.hp <= 0) {
          state.log.push("–ò–≥—Ä–æ–∫ –ø–∞–ª –≤ –±–æ—é...");
          state.phase = Phase.Defeat;
          render();
          stopAutoplay();
          return;
        }
      }
    }

    state.player_turn = !state.player_turn;
    state.round_idx += 1;
    state.log.push(`-- –†–∞—É–Ω–¥ ${state.round_idx} --`);
    render();
  }

  // -------------------- UI --------------------
  const el = id => document.getElementById(id);
  const show = (id, on=true) => el(id).style.display = on ? "" : "none";
  const setText = (id, val) => el(id).textContent = String(val);

  function hpColor(pct){
    // 0% -> red, 100% -> green
    const hue = Math.max(0, Math.min(120, Math.round(pct * 120)));
    return `hsl(${hue} 75% 45%)`;
  }

  function setHPBar(prefix, cur, max){
    const bar = el(prefix+"bar");
    const fill = el(prefix+"bar-fill");
    const txt  = el(prefix+"bar-text");
    if (!bar || !fill || !txt) return;
    const pct = Math.max(0, Math.min(1, max ? cur/max : 0));
    fill.style.width = (pct*100) + "%";
    fill.style.background = hpColor(pct);
    txt.textContent = `${Math.max(cur,0)}/${max}`;
  }

  function flashOnHit(prefix){
    const bar = el(prefix+"bar");
    if (!bar) return;
    bar.classList.remove("hit");
    void bar.offsetWidth;
    bar.classList.add("hit");
    setTimeout(()=>bar.classList.remove("hit"), 500);
  }

  function chipize(id, text, type){
    const chip = el(id);
    chip.classList.remove("red","blue","brown");
    chip.classList.add(dmgChipClass(type));
    chip.querySelector("span").textContent = text;
  }

  function render() {
    // –í–µ—Ä—Ö–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
    setText("wins", state.wins_in_row);
    setText("speedval", `${state.speedMs} –º—Å`);
    el("speed").value = state.speedMs;

    // –°—Ç–∞—Ä—Ç–æ–≤—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã
    setText("bstr", state.base_str);
    setText("bagi", state.base_agi);
    setText("bend", state.base_end);

    // –ü–æ–∫–∞–∑ —Å–µ–∫—Ü–∏–π
    show("choose", state.phase === Phase.Choose);
    show("fight", state.phase === Phase.Fight);
    show("loot", state.phase === Phase.Loot);
    show("levelup", state.phase === Phase.LevelUp);
    show("victory", state.phase === Phase.Victory);
    show("defeat", state.phase === Phase.Defeat);

    // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    el("btn-pause").textContent = autoplayTimer ? "‚è∏ –ü–∞—É–∑–∞" : "‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å";

    // –ò–≥—Ä–æ–∫
    if (state.player){
      const p = state.player;
      setHPBar("p", p.hp, p.max_hp);
      // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —É–¥–∞—Ä–∞
      if (state.prevPlayerHP != null && p.hp < state.prevPlayerHP) flashOnHit("p");
      state.prevPlayerHP = p.hp;

      setText("pstr", p.strength);
      setText("pagi", p.agility);
      setText("pend", p.endurance);
      setText("lv-rogue", p.class_level(CLASS_ROGUE));
      setText("lv-warrior", p.class_level(CLASS_WARRIOR));
      setText("lv-barbarian", p.class_level(CLASS_BARBARIAN));
      setText("wname", p.weapon.name);
      setText("wdmg", p.weapon.damage);
      el("wicon").textContent = weaponIcon(p.weapon.name);
      chipize("wdtype-chip", p.weapon.dmg_type, p.weapon.dmg_type);
    }

    // –ú–æ–Ω—Å—Ç—Ä
    if (state.monster){
      const m = state.monster;
      setText("mname", m.name);
      el("memoji").textContent = monsterIcon(m.name);
      setHPBar("m", m.hp, m.max_hp);
      if (state.prevMonsterHP != null && m.hp < state.prevMonsterHP) flashOnHit("m");
      state.prevMonsterHP = m.hp;

      setText("mstr", m.strength);
      setText("magi", m.agility);
      setText("mend", m.endurance);
      setText("mwname", m.weapon.name);
      setText("mwdmg", m.weapon.damage);
      el("mwicon").textContent = weaponIcon(m.weapon.name);
      chipize("mwdtype-chip", m.weapon.dmg_type, m.weapon.dmg_type);
    }

    // –õ—É—Ç
    if (state.phase === "loot" && state.monster && state.player){
      const drop = state.monster.drop_weapon, cur = state.player.weapon;
      setText("loot-name", drop.name);
      setText("loot-dmg", drop.damage);
      chipize("loot-type-chip", drop.dmg_type, drop.dmg_type);
      el("loot-emoji").textContent = weaponIcon(drop.name);

      setText("curw-name", cur.name);
      setText("curw-dmg", cur.damage);
      chipize("curw-type-chip", cur.dmg_type, cur.dmg_type);
      el("curw-emoji").textContent = weaponIcon(cur.name);
    }

    // –≠—Ñ—Ñ–µ–∫—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É–¥–∞—Ä–∞
    const eff = el("last-effects");
    eff.innerHTML = "";
    if (state.phase === Phase.Fight && state.lastNotes.length){
      state.lastNotes.forEach(n => {
        const d = document.createElement("div");
        d.className = "chip";
        d.textContent = n;
        eff.appendChild(d);
      });
    }

    // –ñ—É—Ä–Ω–∞–ª ‚Äî –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    const logEl = el("log");
    logEl.textContent = state.log.slice(-300).join("\n");
    logEl.scrollTop = logEl.scrollHeight;

    setAutoStatus();
  }

  // -------------------- –°–æ–±—ã—Ç–∏—è --------------------
  document.body.addEventListener("click", (e) => {
    const t = e.target;

    if (t.id === "btn-restart-top" || t.id === "btn-restart-1" || t.id === "btn-restart-2"){
      const ng = newGameState();
      Object.assign(state, ng);
      stopAutoplay();
      render();
      return;
    }

    if (t.id === "btn-pause"){
      if (autoplayTimer){ // pause
        state.auto = false;
        stopAutoplay();
      } else {
        state.auto = true;
        startAutoplay();
      }
      render();
      return;
    }

    if (t.id === "btn-step"){
      if (state.phase === "in_fight"){
        stopAutoplay();
        do_turn();
      }
      return;
    }

    if (t.dataset && t.dataset.action === "choose") {
      const cls = t.dataset.cls;
      state.chosen_class = cls;
      state.player = new Character(state.base_str, state.base_agi, state.base_end, cls);
      const p = state.player;
      state.log.push("");
      state.log.push(`–í—ã –≤—ã–±—Ä–∞–ª–∏: ${cls}`);
      state.log.push(`–ù–∞—á–∞–ª—å–Ω–æ–µ –æ—Ä—É–∂–∏–µ: ${p.weapon.name} (${p.weapon.damage}, ${p.weapon.dmg_type})`);
      state.log.push(`–ó–¥–æ—Ä–æ–≤—å–µ: ${p.hp}/${p.max_hp}`);
      state.log.push(`–£—Ä–æ–≤–Ω–∏: –†–∞–∑–±–æ–π–Ω–∏–∫ ${p.class_level(CLASS_ROGUE)}, –í–æ–∏–Ω ${p.class_level(CLASS_WARRIOR)}, –í–∞—Ä–≤–∞—Ä ${p.class_level(CLASS_BARBARIAN)}`);
      start_fight();
      return;
    }

    if (t.dataset && t.dataset.action === "loot") {
      if (state.phase !== "loot" || !state.player || !state.monster) return;
      const take = t.dataset.take === "yes";
      if (take) {
        state.player.weapon = state.monster.drop_weapon;
        state.log.push(`–í—ã —ç–∫–∏–ø–∏—Ä–æ–≤–∞–ª–∏: ${state.player.weapon.name}`);
      } else {
        state.log.push("–í—ã –æ—Å—Ç–∞–≤–∏–ª–∏ —Ç–µ–∫—É—â–µ–µ –æ—Ä—É–∂–∏–µ.");
      }
      if (state.player.can_level_up()) {
        state.phase = "level_up";
        render();
      } else {
        if (state.wins_in_row >= 5) {
          state.phase = "victory";
          render();
        } else {
          start_fight();
        }
      }
      return;
    }

    if (t.dataset && t.dataset.action === "level") {
      if (state.phase !== "level_up" || !state.player) return;
      const cls = t.dataset.cls;
      const p = state.player;
      const before_hp = p.max_hp, before_str = p.strength, before_agi = p.agility, before_end = p.endurance;
      p.gain_level(cls, true);
      const gained_hp = p.max_hp - before_hp;
      state.log.push(`–ü–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è: +1 —É—Ä–æ–≤–µ–Ω—å –≤ –∫–ª–∞—Å—Å–µ '${cls}'.`);
      state.log.push(`–ü—Ä–∏—Ä–æ—Å—Ç HP: +${gained_hp}. –ú–∞–∫—Å HP: ${p.max_hp}.`);
      state.log.push(`–ê—Ç—Ä–∏–±—É—Ç—ã: –°–∏–ª–∞ ${p.strength} (–±—ã–ª–æ ${before_str}), –õ–æ–≤–∫ ${p.agility} (–±—ã–ª–æ ${before_agi}), –í—ã–Ω–æ—Å ${p.endurance} (–±—ã–ª–æ ${before_end}).`);
      if (state.wins_in_row >= 5) {
        state.phase = "victory";
        render();
      } else {
        start_fight();
      }
      return;
    }
  });

  el("speed").addEventListener("input", (e)=>{
    state.speedMs = Number(e.target.value);
    el("speedval").textContent = `${state.speedMs} –º—Å`;
    if (autoplayTimer){ startAutoplay(); } // –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å –Ω–æ–≤–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é
  });

  // -------------------- –°—Ç–∞—Ä—Ç --------------------
  // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±–æ—Ä –∫–ª–∞—Å—Å–∞ –≤–Ω–∞—á–∞–ª–µ
  render();
  show("choose", true);
})();
</script>
</body>
</html>
